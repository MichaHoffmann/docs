---
title: Linting PromQL expressions using semgrep
created_at: 2023-07-23
kind: article
author_name: Michael Hoffmann (https://github.com/MichaHoffmann)
---

> Michael Hoffmann is an Software Reliability Engineer at [Aiven](https://aiven.io) where he works on all things logs and metrics.

Hi, I'm Michael and in this blog post I would love to share some information on how you can make your alerts and recording rules more reliable and consistent for you and your team using an OSS tool called semgrep.

### Motivation

Writing good alerting rules is surprisingly hard in my experience.

Lets say you run a Thanos cluster with multiple tenants, disambiguated by a `tenant_id` label for each team. Now consider the following alerting rule expression:

```yaml
expr: |
    sum(rate(http_requests_total{route="/health", status~="5.."}[5m])) 
    /
    sum(rate(http_requests_total{route="/health"}[5m])) 
    > 0.1
```

By forgetting to specify the `tenant_id` label matcher we changed the meaning of the alert in an unexpected way.

Or consider the ill-defined toy expression:

```yaml
- expr: |
    sum_over_time(vector(1)[5m:30s]) > 10
```

This seems somewhat contrived but horizontal aggregations over subqueries have caused me some headaches in the past.

Catching problems like that manually in review is too fragile so ideally we want a tool to catch it automatically and is configurable enough to address any in-house rules we might have around our metrics.

Enter [Semgrep OSS](https://github.com/returntocorp/semgrep)!

### Semgrep

Semgrep is a static analysis tool that allows to write patterns that resemble the syntax of the language that is to be analyzed ( and far more, please read the documentation for details ). And I [recently](https://github.com/returntocorp/semgrep/pull/8281) added PromQL support to it!

Installing the semgrep CLI is as simple as

```bash
pip install semgrep
```

Now, having our examples from above in mind, consider the following rules:

```yaml
rules:
- id: extract-alerting-rule-expression-to-promql
  mode: extract
  languages: [yaml]
  pattern: |
    expr: $QUERY
  extract: $QUERY
  dest-language: promql

- id: selectors-should-have-tenant-id
  languages: [promql]
  severity: ERROR
  patterns:
  - pattern-either:
    - pattern: |
       {...}
    - pattern: |
       {...}[$D]
  - pattern-not: |
       {..., tenant_id="my-team", ...}
  - pattern-not: |
       {..., tenant_id="my-team", ...}[$D]
  message: Selector expressions should contain a equality match on the tenant_id label.

- id: no-horizontal-aggregation-over-subqueries
  languages: [promql]
  severity: ERROR
  patterns:
  - pattern-either:
    - pattern: |
        $F((...)[$R:])
    - pattern: |
        $F((...)[$R:$S])
  - metavariable-regex:
        metavariable: $F
        regex: ".*_over_time"
  message: Horizontal aggregations over subqueries can lead to unexpected results.
```

We have defined 3 rules, one for extracting all PromQL expressions by looking for it in the `expr` key of a yaml file and subsequently feeds them into rules that target the PromQL language. The remaining rules define patterns that we want to catch. 

Let's go over some patterns we used here:
  * `{...}` matches any vector selector
  * `{..., tenant_id="my-team", ...}` matches vector selectors that contains the label matcher `tenant_id="my-team"`
  * `{...}[$D]` matches any matrix selector
  * `(...)[$R:$S]` and `(...)[$R:]` together match any subquery
  * `$F(...)` matches function invocation

We can now use semgrep together with those rules to find our offending expressions:

```bash
semgrep scan -c rule.yaml target.yaml

┌─────────────┐
│ Scan Status │
└─────────────┘
  Scanning 1 file tracked by git with 3 Code rules:
  Scanning 1 file.
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00


┌─────────────────┐
│ 3 Code Findings │
└─────────────────┘

    target.yaml
       no-horizontal-aggregation-over-subqueries
          Horizontal aggregations over subqueries can lead to unexpected results.

            7┆ sum_over_time(vector(1)[5m:30s]) > 10
            ⋮┆----------------------------------------
       selectors-should-have-tenant-id
          Selector expressions should contain a equality match on the tenant_id label.

            2┆ sum(rate(http_requests_total{route="/health", status~="5.."}[5m]))
            ⋮┆----------------------------------------
            4┆ sum(rate(http_requests_total{route="/health"}[5m]))



┌──────────────┐
│ Scan Summary │
└──────────────┘
Some files were skipped or only partially analyzed.
  Partially scanned: 1 files only partially analyzed due to parsing or internal Semgrep errors

Ran 3 rules on 1 file: 3 findings.
```

Running this rule now in CI we can rest assured that this class of problem is solved.

PromQL support in semgrep is still experimental, feel free to help us out either by reviewing or providing feedback :hugs: 
